#Database System 1
##数据库定义
数据库管理系统提供数据库语言DDL,DCL,DML给用户  
关系模式（表名 表标题 表内容）  
表/关系
列名/字段/属性
行/元组/元素  
**数据库结构**  
外模式/子模式  
概念模式/全局模式  
内模式/存储模式  
**关系模型**  
基本结构  
基本操作  
完整性约束（实体，参照，自定义）  
候选码->主码 主属性 外码  
**关系代数**  
并 差 积 选择 投影 --连接  
##SQL语言
数据库完整性：完整性规则，静态约束（列约束，表约束），动态约束（触发器）  
完整性约束规则OPAR  
数据库安全性：强制安全性，自主安全性（存储矩阵，视图） 授权 安全性规则：SOTP  
**嵌入式SQL语言**  
交互式SQL 非过程性 难做复杂查询  
嵌入式SQL：exec sql into ":程序变量"  
**动态SQL**  
立即执行：exec sql execute immediate :host  
编译动态参数：exec sql prepare sql_temp from :host   exec sql execute sql_temp using :con  
数据字典/目录 存储数据库各类对象定义信息的表  
ODBC/JDBC java.sql driver driverManagement Connection  
##数据建模  
现实世界->信息世界（概念模型）->数据世界（逻辑层，物理层）  
实体与实体之间的联系 联系基数 建模：chen方法 理解，区分，命名，表达 E-R模型  
**工程化方法IDEF1X**  
实体：独立实体，从属实体（唯一标识依赖于与其他实体的联系）相交实体  
联系：标定联系，非标定联系，分类联系，非确定联系  
**数据库设计**  
需求分析-概念数据库设计-逻辑-物理  
实体的发现，分析与定义->实体属性->实体联系->外部视图与概念视图  
不同层次E-R图：实体级图，键级图，完整图  
逻辑数据库设计：数据依赖，关系范式，模式分解  
物理数据库设计：DBMS选型，数据结构，存储方式，访问控制规则，索引  
**函数依赖**  
完全，部分函数依赖 函数依赖传递  
被F逻辑蕴含的所有函数依赖的集合被称为F的闭包F+ 包含了平凡的函数依赖  
函数依赖的Amstrong公理：传递律，自反律，增广律 最小覆盖  
**关系模式范式**  
1NF 关系中每个分量不可分，不能是复合属性，多值属性及其组合  
2NF 每一非主属性完全函数依赖于候选键，取消了部分依赖  
3NF 在2NF上取消了非主属性对候选键的传递依赖，分解时将每个依赖单独分解成关系再相同主键合并  
**模式分解**  
无损连接分解与保持依赖分解 无损连接：对关系模式R上任意关系r均有r的分解的连接仍等于r 检验算法：构建表看是否存在依赖Ri与所有属性均相关  
保持依赖分解：函数依赖集合F在每个分解的关系模式Ri上的投影的并集逻辑蕴含F中的每个依赖  
关系模式设计：分解为小的关系模式减少了冗余与插删异常，但是连接计算效率低  
数据依赖-关系范式-模式分解  
##数据库物理存储  
计算机系统存储体系 内存（页）-磁盘（扇区/块，磁道，盘面）-磁带  
磁盘数据读写时间：寻道，旋转，传输 减少IO时间，减少寻道寻转时间-连续块存储，同一柱面或多个磁盘并行块存储  
减少读写时间，提高存储可靠性：RAID技术 并行读取多个磁盘，可靠性（奇偶检验与纠错）  
数据存储结构映射：查询操作算法-文件/索引管理（数据逻辑结构）-内存缓冲区管理-磁盘管理读写块  
**数据库索引**  
索引项：索引字段+行指针 索引文件 主文件  
主文件组织方式：堆文件，排序文件，散列文件，聚簇文件 索引文件组织方式：排序，散列  
索引性能好坏：访问时间，插入时间，删除时间，空间负载，支持存取有效性  
稀疏索引：主文件排序存储，空间小，查询慢 索引项指向存储块的指针：主索引  
稠密索引：候选键属性 非候选键（索引字段不重复使主文件排序或引入指针桶）  
排序文件定期数据库重组：主文件与溢出文件  
**数据组织**  
数据库 表空间 系统文件 表  
段 盘区 基本数据块  
创建表：定义模式，定义物理存储结构，定义完整性约束  
主索引：稀疏索引，建立在主码上 辅助索引：稠密索引，建立在其他属性上  
主索引一般为聚簇索引 倒排索引  
B+树索引 n个索引项和n+1个指针位于一个索引块 叶子节点指针指向主文件，指针利用率50-100%  
B树 非叶节点指针也可指向主文件  
可扩展散列索引：线性散列索引  

数据库操作：对单一元组的扫描操作（迭代器），对关系的一趟扫描操作，二趟（多趟）扫描操作  
基于排序的扫描操作，基于散列，基于索引
基于排序的二趟：第一趟划分子表并在内存中将子表排序，第二趟将子表归并。二趟要求表的磁盘快数b< m^2,m为内存页数。否则为多趟
基于散列的二趟：第一趟散列到不同的桶存入内存，然后对每个桶排序合并。
基于索引：操作字段为聚簇索引，则选择操作的IO次数由记录条数减为磁盘块个数

数据库查询优化
	查询语句->（查询编译器，逻辑优化与物理优化）->执行计划->（执行引擎）->对文件、索引、日志管理器的操作->缓存管理器（内存）->存储管理器(硬盘)

数据库事务管理
原子性、一致性、隔离性、持久性  串行时原子性即可保证一致性，并发时需同时满足原子性与隔离性来保证一致性 备份数据到磁盘保证持久性
事务隔离级别：读未提交，读已提交，可重复读，可串行化 解决问题：脏读，不可重复读，幻读
在读未提交下，事务没有提交便落盘，其他事务可能读取到未提交的行
在读已提交下，事务select没有行锁，可能读取到其他事务提交的修改，造成不可重复读
mysql采用mvcc，默认可重复读，可以改为读已提交 mvcc读取版本号低于事务版本号的数据，实际上解决了幻读 select的读取实际为版本号的快照读，而update/inseret/delete的查询为当前读，读取的是实时数据。所以在mvcc中，当前读需要加锁，而select的快照读不需要加锁，增强了并发能力
在mysql可重复读级别下，对索引字段的更新或插入操作会对该数值行加行锁，两侧区间加间隙锁。对非索引字段更新会对整个表加锁
三级封锁协议
	一级：修改数据A时，事务开始加互斥锁X，结束释放锁
	二级：读取数据A时，开始读取加共享锁S，读取结束立即释放S。解决脏读
	三级：读取数据A时，事务开始时加共享锁S，事务结束时才释放锁。解决不可重复读。
两段锁协议 可串行性 冲突可串行化
并发控制方法：基于锁 基于时间戳 基于有效性确认
日志恢复 undo日志与redo日志
mysql索引
索引的数据结构为B+树，与红黑树等二叉树相比B与B+树具有更大的出度，使得树的高度低，查询性能好。B树的节点存储了索引值、数据与指针，B+树存储了索引值与指针，所以B+树有更大的出度。
MyISAM引擎叶子结点存储的是数据存储位置的指针，主索引与辅助索引的区别在于主索引值必须唯一。InnoDB按住索引聚集存储，辅助索引存储的是住索引的值。
explain查询走索引详情
	select——type在普通查询为SIMMPLE，包含UNION时主查询为PRIMARY，之后为UNION；有字查询时字查询为SUBQUERY
	type包括const，ref，range，all。表中只有一条数据直接返回system。const是针对主键或唯一索引的查询，最多返回一条数据。
	ref出现在多表join查询或使用了最左前缀匹配的查询
	index为全索引扫描，一般所查询内容可以在索引中直接获得，并且需要扫描整个索引获得
	all全表扫描 一般查询效率 all<index<range<ref<eq_ref<const<system

在表较小（《2000）或选择性差（不同索引数与记录的比值）时没必要建立索引，对于字符串可以选取一部分建立前缀索引。
在InnoDB上尽量使用自增主键，避免新增值时插入的情况。